<!DOCTYPE html>
<html>
  <head>
    <script src="./dist/fhirclient/build/fhir-client.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

    <style>
      #main {
        background: lightgray;
        margin: 1em;
        padding: 1em;
        font-size: 2em;
      }
    </style>
  </head>

  <body>
    <div id="main"></div>
    <!-- <button id="authorize_button" onclick="handleAuthClick()">
      Authorize Drive Access
    </button>

    <pre id="content" style="white-space: pre-wrap"></pre> -->

    <script>
      //

      var myApp = {}; // will need to delete and use the one in the function later on

      function processRecord(_hospitalDetails) {
        // var myApp = {};

        myApp.smart = _hospitalDetails.sessionDetails;

        console.log(myApp.smart);

        // console.log(myApp.smart.state.tokenResponse.access_token);

        // console.log(myApp.smart.request("metadata"));

        return myApp.smart.state.tokenResponse.access_token;
      }

      all_hospital_info = JSON.parse(localStorage.getItem("hospital_info"));

      const authHeaders = all_hospital_info.hospitals
        .filter((record) => record.sessionDetails !== "")
        .map(processRecord);

      // console.log("These were the found auth headers");

      // console.log(authHeaders.join(" * "));

      var codes = [
        "social-history",
        "vital-signs",
        "imaging",
        "laboratory",
        "procedure",
        "survey",
        "exam",
        "therapy",
        "activity",
      ];

      // all_hospital_info.hospitals.filter(record => record.sessionDetails !== "").map(pullRecords5);

      // all_hospital_info.hospitals.filter(record => record.sessionDetails !== "").map(pullRecords6);

      /****  one of the below two has to do with the capability statements

      all_hospital_info.hospitals.filter(record => record.sessionDetails !== "").map(pullRecords3);
      ****/
      all_hospital_info.hospitals
        .filter((record) => record.sessionDetails !== "")
        .map(pullRecords4);

      all_hospital_info.hospitals
        .filter((record) => record.sessionDetails !== "")
        .map(doTesting);

      //codes.map(code => pullRecords2(code));
      // pullRecords2(codes);

      // Algorithm,

      // Before populating the table, must we await all the data, how long do we await, do we do fetch attempts again

      // Approach sort as the data comes in, should save time

      // need to filter those which have the state variable defined and perform a map on them

      // myApp.smart = client;

      // console.log(myApp.smart.getAuthorizationHeader()); // passed

      // console.log(myApp.smart.request("metadata"));
      /**
    FHIR.oauth2.ready().then(function (client) {
      console.log(client); // added by me
      myApp.smart = client;

      console.log(myApp.smart.getAuthorizationHeader()) // passed

      console.log(myApp.smart.request("metadata"));

      /*
      Details of the various Observation categories can be found here:
      https://build.fhir.org/valueset-observation-category.html#expansion
      
      var codes = [
        "social-history",
        "vital-signs",
        "imaging",
        "laboratory",
        "procedure",
        "survey",
        "exam",
        "therapy",
        "activity",
      ];

      //codes.map(code => pullRecords2(code));

      pullRecords2(codes);

      // pullRecords();
    });

    **/

      async function testPull() {
        myApp.smart.patient
          .read()
          .then(function (response) {
            console.log(response); // Print the patient data
          })
          .catch(function (error) {
            console.error(error); // Handle any errors
          });
      }

      async function pullRecords() {
        myApp.smart.patient
          .request("Observation?query") // , { pageLimit: 0 })
          .then(function (fhir_resource) {
            console.log(fhir_resource);
          });
      }

      async function pullRecords6(_hospitalDetails) {
        myApp.smart = _hospitalDetails.sessionDetails;

        var obs = await fetch(
          myApp.smart.state.serverUrl + "/StructureDefinition",
          {
            headers: {
              Accept: "application/json+fhir",
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(function (data) {
          console.log(`PullRecords : ${data}`);
          return data;
        });

        // creating a Javascript object from JSON string , can also use JSON.parse()

        var responsejson = await obs.json();

        console.log(responsejson);
      }

      async function pullRecords5(_hospitalDetails) {
        myApp.smart = _hospitalDetails.sessionDetails;

        var obs = await fetch(
          myApp.smart.state.serverUrl + "/ImplementationGuide",
          {
            headers: {
              Accept: "application/json+fhir",
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(function (data) {
          console.log(`PullRecords 3 : ${data}`);
          return data;
        });

        // creating a Javascript object from JSON string , can also use JSON.parse()

        var responsejson = await obs.json();

        console.log(responsejson);
      }

      async function pullRecords3(_hospitalDetails) {
        // var loincs = [encodeURIComponent("http://loinc.org|4548-4")]; //4548-4 = HgA1C  //4544-3 = hematocrit
        // console.log(loincs);

        observation_codes = ["social-history", "vital-signs"];

        myApp.smart = _hospitalDetails.sessionDetails;
        // fOR
        // patient is must for the resources
        // the category or code is a must for an observation resource, there are 7 possible options

        // when a search is performed, some servers return errors
        // others return the default output TOOK A SCREENSHOT OF THIS

        var obs = await fetch(
          myApp.smart.state.serverUrl +
            "/Observation?patient=" +
            myApp.smart.patient.id +
            "&category=vital-signs" +
            // "&category=" +
            // observation_codes.join(",") +
            //  "&code-value-quantity:missing=" false +
            // "&code=8867-4"+  // works
            //  "&code-value-quantity=8867-4$eq79"+
            "&component-value-quantity=79" +
            // "&value-quantity=79" +
            // "&combo-value-quantity=59"+
            //"&result.code-value-quantity=8867-4"+

            "&_summary=true",
          {
            headers: {
              Accept: "application/json+fhir",
              // myApp.smart.getAuthorizationHeader()
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(function (data) {
          return data;
        });

        // creating a Javascript object from JSON string , can also use JSON.parse()

        var responsejson = await obs.json();

        console.log(responsejson);
        console.log(`PullRecords 3 : ${responsejson}`);
        /**
      for (let i in responsejson.entry) {
        if (
          responsejson.entry[i].resource.category[0].coding[0]["code"] ===
          "social-history"
        ) {
          // console.log(responsejson.entry[i]);

          if (
            responsejson.entry[i].resource?.code?.text.match(
              /SHX|MHX|FHX/
            ) !== null
          ) {
            const datafields = {
              date: responsejson.entry[i].resource?.effectiveDateTime || "",
              observation:
                responsejson.entry[i].resource?.code?.coding[0]?.display ||
                "",
              response:
                responsejson.entry[i].resource?.valueCodeableConcept?.text ||
                "",

              // date: ( typeof response.entry[i].resource.code.effectiveDateTime !== 'undefined' ) ? response.entry[i].resource.code.effectiveDateTime : '',
              // observation: ( typeof response.entry[i].resource.code.coding.text !== 'undefined' ) ? response.entry[i].resource.code.coding.text : '',
              // state: ( typeof response.entry[i].resource.valueCodeableConcept.text !== 'undefined' ) ? response.entry[i].resource.valueCodeableConcept.text : '',
            };

            //console.log(datafields);
          }
        }


        if ( responsejson.entry[i].resource.category[0].coding[0]["code"] ===
        "vital-signs"){
          console.log(responsejson.entry[i]);

          if (responsejson.entry[i].resource.component === undefined ){
            console.log("Yes");

            const datafields = {
              date: responsejson.entry[i].resource?.effectiveDateTime || "",
              observation:
                responsejson.entry[i].resource?.code?.coding[0]?.display ||
                "",
              measurement:
                responsejson.entry[i].resource?.valueQuantity?.value.concat(" ", responsejson.entry[i].resource?.valueQuantity?.unit || "unit")  ||
                "",

              // date: ( typeof response.entry[i].resource.code.effectiveDateTime !== 'undefined' ) ? response.entry[i].resource.code.effectiveDateTime : '',
              // observation: ( typeof response.entry[i].resource.code.coding.text !== 'undefined' ) ? response.entry[i].resource.code.coding.text : '',
              // state: ( typeof response.entry[i].resource.valueCodeableConcept.text !== 'undefined' ) ? response.entry[i].resource.valueCodeableConcept.text : '',
            };

            console.log(datafields);

          }else{
console.log("no");

          };

        };



      }
    
    **/
      }

      async function pullRecords4(_hospitalDetails) {
        myApp.smart = _hospitalDetails.sessionDetails;
        // fOR
        // patient is must for the resources
        // the category or code is a must for an observation resource, there are 7 possible options

        // when a search is performed, some servers return errors
        // others return the default output TOOK A SCREENSHOT OF THIS

        var obs = await fetch(
          myApp.smart.state.serverUrl + "/metadata",
          // "/CapabilityStatement?patient=" +
          // myApp.smart.patient.id ,
          {
            headers: {
              Accept: "application/json+fhir",
              // myApp.smart.getAuthorizationHeader()
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(async function (data) {
          console.log(`PullRecords 4 : ${JSON.stringify(data)}`);
          return data;
        });

        // creating a Javascript object from JSON string , can also use JSON.parse()

        // exportPDF()
        // writeToPDF(responsejson, "ehr")

        // console.log(responsejson);
      }

      async function pullRecords2(observation_codes) {
        // var loincs = [encodeURIComponent("http://loinc.org|4548-4")]; //4548-4 = HgA1C  //4544-3 = hematocrit
        // console.log(loincs);

        var obs = await fetch(
          myApp.smart.state.serverUrl +
            "/Observation?patient=" +
            myApp.smart.patient.id +
            "&category=" +
            observation_codes.join(",") +
            "&_summary=true",
          {
            headers: {
              Accept: "application/json+fhir",
              // myApp.smart.getAuthorizationHeader()
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(function (data) {
          console.log(`PullRecords 2 : ${JSON.stringify(data)}`);
          return data;
        });

        // creating a Javascript object from JSON string , can also use JSON.parse()

        var responsejson = await obs.json();

        console.log(responsejson);
        console.log(`PullRecords 4 : ${responsejson}`);

        for (let i in responsejson.entry) {
          if (
            responsejson.entry[i].resource.category[0].coding[0]["code"] ===
            "social-history"
          ) {
            // console.log(responsejson.entry[i]);

            if (
              responsejson.entry[i].resource?.code?.text.match(
                /SHX|MHX|FHX/
              ) !== null
            ) {
              const datafields = {
                date: responsejson.entry[i].resource?.effectiveDateTime || "",
                observation:
                  responsejson.entry[i].resource?.code?.coding[0]?.display ||
                  "",
                response:
                  responsejson.entry[i].resource?.valueCodeableConcept?.text ||
                  "",

                // date: ( typeof response.entry[i].resource.code.effectiveDateTime !== 'undefined' ) ? response.entry[i].resource.code.effectiveDateTime : '',
                // observation: ( typeof response.entry[i].resource.code.coding.text !== 'undefined' ) ? response.entry[i].resource.code.coding.text : '',
                // state: ( typeof response.entry[i].resource.valueCodeableConcept.text !== 'undefined' ) ? response.entry[i].resource.valueCodeableConcept.text : '',
              };

              //console.log(datafields);
            }
          }

          if (
            responsejson.entry[i].resource.category[0].coding[0]["code"] ===
            "vital-signs"
          ) {
            console.log(responsejson.entry[i]);

            if (responsejson.entry[i].resource.component === undefined) {
              console.log("Yes");

              const datafields = {
                date: responsejson.entry[i].resource?.effectiveDateTime || "",
                observation:
                  responsejson.entry[i].resource?.code?.coding[0]?.display ||
                  "",
                measurement:
                  responsejson.entry[i].resource?.valueQuantity?.value.concat(
                    " ",
                    responsejson.entry[i].resource?.valueQuantity?.unit ||
                      "unit"
                  ) || "",

                // date: ( typeof response.entry[i].resource.code.effectiveDateTime !== 'undefined' ) ? response.entry[i].resource.code.effectiveDateTime : '',
                // observation: ( typeof response.entry[i].resource.code.coding.text !== 'undefined' ) ? response.entry[i].resource.code.coding.text : '',
                // state: ( typeof response.entry[i].resource.valueCodeableConcept.text !== 'undefined' ) ? response.entry[i].resource.valueCodeableConcept.text : '',
              };

              console.log(datafields);
              console.log(`PullRecords Act : ${datafields}`);
            } else {
              console.log("no");
            }
          }
        }
      }

      async function doRequests() {
        var loincs = [encodeURIComponent("http://loinc.org|4548-4")]; //4548-4 = HgA1C  //4544-3 = hematocrit
        var obs = await fetch(
          myApp.smart.state.serverUrl +
            "/Observation?patient=" +
            myApp.smart.patient.id +
            "&limit=50&code=" +
            loincs.join(","),
          {
            headers: {
              Accept: "application/json+fhir",
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(function (data) {
          return data;
        });

        var response = await obs.json();

        // console.log(response);

        var toInsert = "";

        //if there is no entry, then there was no test found
        if (!response.entry[0]) {
          toInsert +=
            "We could not find you were tested for HgA1C at this provider.";
        } else {
          toInsert +=
            "Your HgA1C was tested on " +
            response.entry[0].resource.effectiveDateTime +
            "<br/><br/>";

          toInsert +=
            "Your HgA1C was " +
            response.entry[0].resource.valueQuantity.value +
            "<br/><br/>";

          toInsert +=
            "<a href='https://en.wikipedia.org/wiki/Glycated_hemoglobin'>According to wikipedia</a>, A1c is measured primarily to determine the three-month average blood sugar level and can be used as a diagnostic test for diabetes mellitus.  <5.7%	Normal, 5.7-6.4%	Prediabetes, >6.5%	Diabetes.";
        }

        $("#main").html(toInsert);
      }

      // Algorithm

      // get bundle of observations, filter and apply to the result an operation, perhaps creating a list of items

      // Potential display items

      // ['HeartRate', 'BodyHeight', 'BodyWeight', 'VitalsPanel', 'RespRate', 'BodyTemp', 'HeadCircum', 'OxygenSat', 'BMI', 'BP', 'HDLCholesterol', 'Cholesterol' ]

      vital_signs_data = {
        "8302-2": { display: "Body Height", results: [] }, // https://hl7.org/fhir/R4/bodyheight.html
        "8867-4": { display: "Heart Rate", results: [] }, // https://hl7.org/fhir/R4/heartrate.html#10.1.25.2
        "29463-7": { display: "Body Weight", results: [] }, // https://hl7.org/fhir/R4/bodyweight.html
        "9279-1": { display: "Respiratory Rate", results: [] }, // https://hl7.org/fhir/R4/resprate.html
        "8310-5": { display: "Body Temperature", results: [] }, // https://hl7.org/fhir/R4/bodytemp.html
        "9843-4": { display: "Head Circumferencee", results: [] }, // https://hl7.org/fhir/R4/headcircum.html
        "2708-6": { display: "Oxygen Saturation", results: [] }, // https://hl7.org/fhir/R4/oxygensat.html
        "39156-5": { display: "Body Mass Index", results: [] }, // https://hl7.org/fhir/R4/bmi.html
        "85354-9": {
          component: {
            systolic_bp_8480_6: {
              display: "Systolic Blood Pressure",
              results: [],
            },
            diastolic_bp_8462_4: {
              display: "Diastolic Blood Pressure",
              results: [],
            },
          },
        }, // https://hl7.org/fhir/R4/bp.html
        "2085-9": { display: "HDL Cholesterol", results: [] }, // https://hl7.org/fhir/R4/hdlcholesterol.html
      };

      async function doTesting(_hospitalDetails) {
        // not all servers contain the same search parameters, code would be useful but we may not be able to exploit it in all cases

        myApp.smart = _hospitalDetails.sessionDetails;

        var obs = await fetch(
          myApp.smart.state.serverUrl +
            "/Observation?patient=" +
            myApp.smart.patient.id, // +
          // "&limit=50&code=" +
          //  loincs.join(",")
          {
            headers: {
              Accept: "application/json+fhir",
              Authorization:
                "Bearer " + myApp.smart.state.tokenResponse.access_token,
            },
          }
        ).then(function (data) {
          return data;
        });

        var _response = await obs.json();

        // all_hospital_info.hospitals.filter(record => record.sessionDetails !== "").map(pullRecords4);

        console.log(Object.keys(vital_signs_data));

        console.log(_response);

        Object.keys(vital_signs_data).forEach((_loinc_code) =>
          parsingFunction(_loinc_code, _response)
        );

        // loinc_code_index = vital_signs_data.indexOf(loinc_code)

        // Append Google Auth Button
        var div = document.createElement("div");
        div.id = "fhir-data";
        div.innerHTML = `<p>Data From FHIR: </br></br> ${JSON.stringify(
          vital_signs_data
        )}</p>
        <br><br> 
        <button id="authorize_button" onclick="oauthSignIn()">
          Authorize Drive Access
        </button>
        <pre id="content" style="white-space: pre-wrap"></pre>`;

        document.body.appendChild(div);
        writeToPDF(vital_signs_data);
      }

      function setResult(loinc_code, observation, item_code = null) {
        if (
          item_code === null &&
          observation.resource.code.coding.filter(
            (item) => item.code === loinc_code
          ).length === 1 &&
          typeof observation.resource.valueQuantity.code !== "undefined"
        ) {
          vital_signs_data[loinc_code].results.push({
            value: observation.resource.valueQuantity.value,
            code: observation.resource.valueQuantity.code,
          });
        } else if (
          item_code === "8480-6" &&
          observation.resource.component?.code?.coding.filter(
            (item) => item.code === "8480-6"
          ).length === 1 &&
          typeof observation.resource.valueQuantity.code !== "undefined"
        ) {
          vital_signs_data[
            loinc_code
          ].component.systolic_bp_8480_6.results.push({
            value: observation.resource.valueQuantity.value,
            code: observation.resource.valueQuantity.code,
          });
        } else if (
          item_code === "8462-4" &&
          observation.resource.component?.code?.coding.filter(
            (item) => item.code === "8462-4"
          ).length === 1 &&
          typeof observation.resource.valueQuantity.code !== "undefined"
        ) {
          vital_signs_data[
            loinc_code
          ].component.diastolic_bp_8462_4.results.push({
            value: obs_resource.valueQuantity.value,
            code: obs_resource.valueQuantity.code,
          });
        }

        // var responsejson = await obs.json();
      }

      /**
function setResult(loinc_code, _observation, item_code)
{

if ( _observation.resource.component.code.coding.filter(item => item.code === '8480-6').length === 1 & observation.resource.valueQuantity.code  !== 'undefined' ){

vital_signs_data[loinc_code].results.push({ 'value': observation.resource.valueQuantity.value, 'code': observation.resource.valueQuantity.code}) ;

}

 
}
**/

      function parsingFunction(loinc_code, response) {
        console.log(loinc_code);

        if (loinc_code !== "85354-9") {
          response.entry.forEach(
            (observation) => setResult(loinc_code, observation) // console.log(observation.resource.code.coding.filter(item => item.code === loinc_code).length)
          );
        } // specifically for blood pressure that has two readings
        else {
          response.entry.forEach((observation) =>
            setResult(loinc_code, observation, "8480-6")
          );

          response.entry.forEach((observation) =>
            setResult(loinc_code, observation, "8462-4")
          );
        }
      }

      // Bundle level or Resource level
      // if at bundle , loop such that we at resource level
      // Given a resource what next
      // if the resource is observation type, create a list of resources we would like to check for
      // Handling cardinality, using the must included fields for certain profiles
      // look though each loinc code provided for matches, special case applies for BP
    </script>

    <script type="text/javascript">
      function oauthSignIn() {
        // Google's OAuth 2.0 endpoint for requesting an access token
        var oauth2Endpoint = "https://accounts.google.com/o/oauth2/v2/auth";

        // Create <form> element to submit parameters to OAuth 2.0 endpoint.
        var form = document.createElement("form");
        form.setAttribute("method", "GET"); // Send as a GET request.
        form.setAttribute("action", oauth2Endpoint);

        // Parameters to pass to OAuth 2.0 endpoint.
        var params = {
          client_id:
            "477284413775-mcpsidbq6ncr5d46c1pa1urfh4b1ri2i.apps.googleusercontent.com",
          redirect_uri: "http://localhost:5500/app.html",
          response_type: "token",
          scope: "https://www.googleapis.com/auth/drive.file",
          include_granted_scopes: "true",
          state: "pass-through value",
        };

        // Add form parameters as hidden input values.
        for (var p in params) {
          var input = document.createElement("input");
          input.setAttribute("type", "hidden");
          input.setAttribute("name", p);
          input.setAttribute("value", params[p]);
          form.appendChild(input);
        }

        document.body.appendChild(form);
        form.submit();
      }

      async function pushFileToDrive(blob, token) {
        const formData = new FormData();

        const metadata = {
          name: "Electronic Medical Records.pdf",
          mimeType: "application/pdf",
        };

        formData.append(
          "metadata",
          new Blob([JSON.stringify(metadata)], { type: "application/json" })
        );
        formData.append("file", blob);

        const options = {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          body: formData,
        };

        console.log("Starting uploading");

        try {
          const uploadResponse = await fetch(
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
            options
          );
          const fileData = await uploadResponse.json();

          if (uploadResponse.ok) {
            console.log("EHR document uploaded successfully:", fileData);

            // Share the uploaded PDF file
            await shareFileWithUser(fileData.id, token);
          } else {
            console.error("Failed to upload EHR document:", fileData);
          }
        } catch (error) {
          console.error("Error uploading EHR document:", error);
        }
      }

      async function shareFileWithUser(fileId, token) {
        const permissions = {
          type: "user",
          role: "reader",
          emailAddress: "bmurenzi@andrew.cmu.edu",
        };

        const permissionsOptions = {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(permissions),
        };

        try {
          const permissionsResponse = await fetch(
            `https://www.googleapis.com/drive/v3/files/${fileId}/permissions`,
            permissionsOptions
          );
          const permissionsData = await permissionsResponse.json();

          if (permissionsResponse.ok) {
            console.log("EHR document shared successfully:", permissionsData);
          } else {
            console.error("Failed to share EHR document:", permissionsData);
          }
        } catch (error) {
          console.error("Error sharing EHR document:", error);
        }
      }

      async function writeToPDF(json_data) {
        const records = JSON.stringify(json_data);

        const { jsPDF } = window.jspdf;
        var doc = new jsPDF();

        doc.setFontSize(16);
        const offSet = 10;
        let startY = 20;

        doc.text(startY, 20, "Medical Records");
        startY += 10;
        doc.text(offSet, 30, "===================");
        startY += 15;

        const fontSize = 8;
        const maxWidth = +doc.internal.pageSize.width;
        const splitText = doc.splitTextToSize(
          JSON.stringify(json_data),
          maxWidth * 1.8
        );
        const textWidth = splitText.reduce(
          (max, line) => Math.max(max, doc.getStringUnitWidth(line) * fontSize),
          0
        );
        const lineHeight = fontSize * 1.2;
        const numLines = Math.ceil(textWidth / maxWidth);

        doc.setFontSize(fontSize);

        splitText.forEach((line, index) => {
          const xPos =
            (doc.internal.pageSize.width -
              doc.getStringUnitWidth(line) * fontSize) /
            2;
          const yPos = startY + index * lineHeight;
          if (doc.internal.pageSize.height - yPos < lineHeight) {
            doc.addPage();
            doc.text(line, offSet, yPos);
          } else {
            doc.text(line, offSet, yPos);
          }
        });

        // Generate the PDF as a blob object
        const pdfBlob = doc.output("blob");

        // Get token from current URL
        const accessToken = new URL(window.location.href).hash
          .split("&")
          .reduce((acc, current) => {
            const [key, value] = current.split("=");
            if (key === "access_token") {
              acc = decodeURIComponent(value);
            }
            return acc;
          }, "");

        // upload the PDF to drive
        await pushFileToDrive(pdfBlob, accessToken);
      }
    </script>
  </body>
</html>
